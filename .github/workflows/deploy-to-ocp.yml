name: Build and Deploy to OpenShift

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout the repository
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install CLI tools from OpenShift Mirror
        uses: redhat-actions/openshift-tools-installer@v1
        with:
          # "mirror" is the default source, so this is optional.
          source: "mirror"
      # 2. Log in to OpenShift
      - name: Log in to OpenShift
        uses: redhat-actions/oc-login@v1
        with:
          openshift_server_url: ${{ secrets.OPENSHIFT_SERVER }}
          openshift_token: ${{ secrets.OPENSHIFT_TOKEN }}

      # 3. Build the Docker image
      - name: Build Docker image
        run: docker build -t hello-world-app .

      # 4. Tag the image for OpenShift registry
      - name: Tag Docker image for OpenShift
        run: |
          REGISTRY=$(oc get route -n openshift-image-registry default-route --template='{{ .spec.host }}')
          docker tag hello-world-app:latest $REGISTRY/my-project/hello-world-app:latest

      # 5. Push the image to the OpenShift internal registry
      - name: Push Docker image to OpenShift registry
        run: |
          REGISTRY=$(oc get route -n openshift-image-registry default-route --template='{{ .spec.host }}')
          docker login -u $(oc whoami) -p $(oc whoami -t) $REGISTRY
          docker push $REGISTRY/my-project/hello-world-app:latest

      # 6. Deploy the application in OpenShift
      - name: Deploy application in OpenShift
        run: |
          oc project github-test-1
          oc new-app my-project/hello-world-app:latest --name=hello-world-app || true
          oc expose svc/hello-world-app || true
